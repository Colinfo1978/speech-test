<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>Glorious Voice Translator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #d0f0c0 0%, #6fbf73 100%);
            color: #333;
            text-align: center;
        }
        select, button {
            font-size: 1rem;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        button {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            color: white;
            transition: 0.3s;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        #resultA, #resultB, #translatedA, #translatedB {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            min-height: 40px;
        }

        #status {
            font-weight: bold;
            color: darkgreen;
            background-color: #fef6d8;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            justify-content: center;
        }

        .msg-box {
            flex: 1;
            height: 150px;
            background-color: #f0f0f0;
            border-radius: 8px;
            box-sizing: border-box;
            margin: 5px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .msg-box div {
            flex: 1;
            overflow-y: auto;
            text-align: center;
            padding: 5px;
            word-wrap: break-word;
        }

        figcaption {
            font-weight: bold;
            margin-bottom: 1px;
        }

        .rotate180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body onload="appInit()">

<h1>Glorious Voice Translator</h1>

<div class="UserA rotate180">
    <h2>User A</h2>
    <label for="langA">User A èªç³»ï¼š</label>
    <select id="langA">
        <option value="zh-TW">ä¸­æ–‡</option>
        <option value="en-US">English</option>
        <option value="ja-JP">æ—¥æœ¬èª</option>
        <option value="fr-FR">FranÃ§ais</option>
    </select>
    <button id="btnA" onclick="startRecognition('A')">User A é–‹å§‹èªªè©±</button>
    <div class="row">
        <figure class="msg-box">
            <figcaption>èªéŸ³è¾¨è­˜</figcaption>
            <div id="resultA"></div>
        </figure>
        <figure class="msg-box">
            <figcaption>ç¿»è­¯çµæœ</figcaption>
            <div id="translatedB"></div>
        </figure>
    </div>
</div>

<div>
    <figure class="msg-box">
        <label>ç›®å‰ç‹€æ…‹:</label>
        <div id="status">ğŸš€ Gloriouslink Voice Translator</div>
    </figure>
</div>

<div>
    <h2>User B</h2>
    <label for="langB">User B èªç³»ï¼š</label>
    <select id="langB">
        <option value="zh-TW">ä¸­æ–‡</option>
        <option value="en-US">English</option>
        <option value="ja-JP">æ—¥æœ¬èª</option>
        <option value="fr-FR">FranÃ§ais</option>
    </select>
    <button id="btnB" onclick="startRecognition('B')">User B é–‹å§‹èªªè©±</button>
    <div class="row">
        <figure class="msg-box">
            <figcaption>èªéŸ³è¾¨è­˜</figcaption>
            <div id="resultB"></div>
        </figure>
        <figure class="msg-box">
            <figcaption>ç¿»è­¯çµæœ</figcaption>
            <div id="translatedA"></div>
        </figure>
    </div>
</div>

<script>

    let counter = 0;

    let recognition;
    let stream; // å­˜æ”¾ MediaStream
    let timeoutTimer; // è¨˜éŒ„è¶…æ™‚è¨ˆæ™‚å™¨
    const MAX_DURATION = 10000; // 10ç§’è¶…æ™‚

    // ç´€éŒ„ç‹€æ…‹è¨Šæ¯
    function showStatus(message) {
        //document.getElementById("status").innerText = message;
        const statusEl = document.getElementById("status");
        const newMsg = `<div>${message}</div>`;
        statusEl.innerHTML = newMsg + statusEl.innerHTML;
    }

    function appInit() {
        showStatus("ğŸš€ æ‡‰ç”¨ç¨‹å¼å·²å•Ÿå‹•.");
        checkMicrophonePermission();
    }

    // åœæ­¢ä¸¦é‡‹æ”¾éº¥å…‹é¢¨è³‡æº
    function stopStream() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            showStatus("ğŸ¤ éº¥å…‹é¢¨å·²é‡‹æ”¾");
        }
    }

    function checkMicrophonePermission() {

      counter++;
      console.log(`ğŸ”¢ checkMicrophonePermission ç¬¬ ${counter} æ¬¡åŸ·è¡Œ`);
      console.trace("ğŸ“ å‘¼å«ä¾†æº");

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("âŒ ç€è¦½å™¨ä¸æ”¯æ´ getUserMediaï¼");
      return;
      }


        try {
          console.log("âœ… å‘¼å« getUserMedia ä¸­...");

          navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
               console.log("âœ… æˆåŠŸå–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼");
               showStatus("ğŸ¤ éº¥å…‹é¢¨æ¬Šé™å·²æˆæ¬Šï¼");
               stream.getTracks().forEach(track => track.stop());
            })
            .catch(function(err) {
               console.log("âŒ ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼š", err);
               showStatus("âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ï¼" + err);
               //alert('éŒ¯èª¤: ' + err);
            });
        } catch (e) {
          console.error("ğŸš« å‘¼å« getUserMedia æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", e);
          alert("ğŸš« å‘¼å« getUserMedia æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + e);
          }

            /*
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    showStatus("ğŸ¤ éº¥å…‹é¢¨æ¬Šé™å·²æˆæ¬Šï¼");
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(function(err) {
                    showStatus("âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ï¼");
                    //alert("éœ€è¦éº¥å…‹é¢¨æ¬Šé™æ‰èƒ½ä½¿ç”¨èªéŸ³è¾¨è­˜åŠŸèƒ½ï¼");
                    alert('éŒ¯èª¤:', err);
                });

            */
    }

    function startRecognition(user) {
        if (!('webkitSpeechRecognition' in window)) {
            //alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API");
            showStatus("âš ï¸ç›®å‰ä½¿ç”¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼");
            return;
        }

        // æ¯æ¬¡æŒ‰ä¸‹æŒ‰éˆ• å…ˆæŠŠä¹‹å‰å ç”¨çš„è³‡æºé‡‹æ”¾å‡ºä¾†
        if (recognition) {
            try {
                recognition.abort();
                showStatus("âœ… é‡‹æ”¾èªéŸ³è¾¨è­˜è³‡æºã€‚");
            } catch(e) {
                //console.warn("abort() å¤±æ•—", e);
                showStatus("ğŸš« ç„¡æ³•é‡‹æ”¾èªéŸ³è¾¨è­˜è³‡æº:" + e);
            }
            recognition = null;
            showStatus("âœ… recognition ç‚º nullã€‚");
        }

        //stopStream();

        checkMicrophonePermission();

        const langA = document.getElementById('langA').value;
        const langB = document.getElementById('langB').value;

        const btn = document.getElementById(user === 'A' ? 'btnA' : 'btnB');
        const result = document.getElementById(user === 'A' ? 'resultA' : 'resultB');

        const userLang = user === 'A' ? langA : langB;
        const targetLang = user === 'A' ? langB : langA;

        recognition = new webkitSpeechRecognition();
        recognition.lang = userLang;
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        btn.disabled = true;
        btn.innerText = "ğŸ™ï¸ è¾¨è­˜ä¸­...";

        // å•Ÿå‹•è¶…æ™‚è¨ˆæ™‚å™¨
        clearTimeout(timeoutTimer);
        showStatus(`â³ è¨ˆæ™‚å™¨å•Ÿå‹•ã€‚`)

        /*
        timeoutTimer = setTimeout(() => {
            //console.warn("è¾¨è­˜è¶…æ™‚ï¼Œè‡ªå‹•åœæ­¢ã€‚");
            //showStatus(`è¾¨è­˜è¶…æ™‚ï¼Œè‡ªå‹•åœæ­¢ã€‚`)
            recognition.abort();
            //alert("è¾¨è­˜è¶…æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼");
            showStatus(`ğŸš« è¾¨è­˜è¶…æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼`);
            //resetButton(btn, user);
        }, MAX_DURATION);
        */

        showStatus(`ğŸ™ï¸ User ${user} é–‹å§‹èªéŸ³è¾¨è­˜ (${userLang})...`);

        recognition.onspeechstart = function(event) {
          showStatus(`âœ… User ${user} é–‹å§‹æ¥å—èªéŸ³:` + event);
        };

        recognition.onspeechend = function(event) {
          showStatus(`âœ… User ${user} çµæŸæ¥å—èªéŸ³:` + event);
        };

        recognition.onnomatch = function(event) {
          showStatus(`âœ… User ${user} æ²’æœ‰ç›¸æ‡‰çš„èªéŸ³` + event);
        };

        recognition.onresult = function(event) {
            clearTimeout(timeoutTimer); // æˆåŠŸå¾Œæ¸…é™¤è¶…æ™‚
            const transcript = event.results[0][0].transcript;
            result.innerHTML = `<div>${transcript}</div>` + result.innerHTML;
            showStatus(`âœ… User ${user} èªéŸ³è¾¨è­˜å®Œæˆï¼Œæº–å‚™ç¿»è­¯...`);

            if (window.Android && window.Android.translate) {
                const fromLang = userLang.substring(0, 2);
                const toLang = targetLang.substring(0, 2);
                window.Android.translate(transcript, fromLang, toLang);
            }
        };

        recognition.onerror = function(event) {
            clearTimeout(timeoutTimer); // è¾¨è­˜éŒ¯èª¤å¾Œæ¸…é™¤è¶…æ™‚
            //alert("è¾¨è­˜éŒ¯èª¤: " + event.error);
            showStatus(`âŒ User ${user} è¾¨è­˜éŒ¯èª¤: ${event.error}`);
            btn.disabled = false;
            btn.innerText = user === 'A' ? "User A é–‹å§‹èªªè©±" : "User B é–‹å§‹èªªè©±";
        };

        recognition.onend = function() {
            clearTimeout(timeoutTimer); // çµæŸå¾Œæ¸…é™¤è¶…æ™‚
            btn.disabled = false;
            btn.innerText = user === 'A' ? "User A é–‹å§‹èªªè©±" : "User B é–‹å§‹èªªè©±";
            showStatus(`ğŸ›‘ User ${user} è¾¨è­˜çµæŸã€‚`);
        };

        //recognition.start();

        try {
              recognition.start();
              //console.log("ğŸ™ï¸ SpeechRecognition å·²å•Ÿå‹•ï¼");
              showStatus(`ğŸ™ï¸ User ${user} SpeechRecognition å·²å•Ÿå‹•ã€‚`);
            } catch (e) {
              //console.error("ğŸš« SpeechRecognition.start() ä¾‹å¤–ç™¼ç”Ÿ:", e);
              //alert("ğŸš« å•Ÿå‹•èªéŸ³è¾¨è­˜æ™‚ç™¼ç”Ÿä¾‹å¤–ï¼š" + e.message);
              showStatus(`ğŸš« User ${user} å•Ÿå‹•èªéŸ³è¾¨è­˜æ™‚ç™¼ç”Ÿä¾‹å¤–ï¼š` + e.message);
            }

    }

    function showTranslatedText(originalText, translatedText, targetLang) {
        const target = targetLang.toLowerCase();
        if (target === document.getElementById('langA').value.substring(0,2)) {
            translatedB.innerHTML = `<div>${translatedText}</div>` + translatedB.innerHTML;
            showStatus(`ğŸŒ ç¿»è­¯å®Œæˆ (User B â” User A): ${translatedText}`);
        } else if (target === document.getElementById('langB').value.substring(0,2)) {
            translatedA.innerHTML = `<div>${translatedText}</div>` + translatedA.innerHTML;
            showStatus(`ğŸŒ ç¿»è­¯å®Œæˆ (User A â” User B): ${translatedText}`);
        }
    }
</script>

</body>
</html>
