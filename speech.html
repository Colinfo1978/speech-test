<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>Glorious Voice Translator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #d0f0c0 0%, #6fbf73 100%);
            color: #333;
            text-align: center;
        }
        select, button {
            font-size: 1rem;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        button {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            color: white;
            transition: 0.3s;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        #resultA, #resultB, #translatedA, #translatedB {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            min-height: 40px;
        }

        #status {
            font-weight: bold;
            color: darkgreen;
            background-color: #fef6d8;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: inline-block;
        }

        .row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            justify-content: center;
        }

        .msg-box {
            flex: 1;
            height: 150px;
            background-color: #f0f0f0;
            border-radius: 8px;
            box-sizing: border-box;
            margin: 5px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .msg-box div {
            flex: 1;
            overflow-y: auto;
            text-align: center;
            padding: 5px;
            word-wrap: break-word;
        }

        figcaption {
            font-weight: bold;
            margin-bottom: 1px;
        }

        .rotate180 {
            transform: rotate(180deg);
        }

        #volumeWrapper {
          width: 300px;
          height: 20px;
          background: #ddd;
          margin-top: 10px;
        }
        #volumeBar {
          height: 100%;
          width: 0;
          background: red;
          transition: width 0.1s;
        }

        /* é–ƒçˆå‹•ç•« */
        @keyframes blink {
            0% { background-color: #4CAF50; }
            50% { background-color: #FF4081; }
            100% { background-color: #4CAF50; }
        }

        .blinking {
            animation: blink 1s infinite;
        }

        @keyframes flash {
          0% { box-shadow: 0 0 5px 2px #ff6666; }
          50% { box-shadow: 0 0 15px 6px #ff0000; }
          100% { box-shadow: 0 0 5px 2px #ff6666; }
        }

        .flash-button {
          animation: flash 1s infinite;
        }
    </style>
</head>
<body onload="appInit()">

<h1>Glorious Voice Translator</h1>

<div class="UserA rotate180">
    <h2>User A</h2>
    <label for="langA">User A èªç³»ï¼š</label>
    <select class="control" id="langA">
        <option value="zh-TW">ä¸­æ–‡</option>
        <option value="en-US">English</option>
        <option value="ja-JP">æ—¥æœ¬èª</option>
        <option value="fr-FR">FranÃ§ais</option>
    </select>
    <button class="control" id="btnA" onclick="startRecognition('A')">User A é–‹å§‹èªªè©±</button>
    <div class="row">
        <figure class="msg-box">
            <figcaption>èªéŸ³è¾¨è­˜</figcaption>
            <div id="resultA"></div>
        </figure>
        <figure class="msg-box">
            <figcaption>ç¿»è­¯çµæœ</figcaption>
            <div id="translatedB"></div>
        </figure>
    </div>
</div>

<!--
<div id="volumeWrapper"><div id="volumeBar"></div></div>
!-->

<div>
    <figure class="msg-box">
        <label>ç›®å‰ç‹€æ…‹:</label>
        <div id="status">ğŸš€ Gloriouslink Voice Translator</div>
    </figure>
</div>

<div>
    <h2>User B</h2>
    <label for="langB">User B èªç³»ï¼š</label>
    <select class="control" id="langB">
        <option value="zh-TW">ä¸­æ–‡</option>
        <option value="en-US">English</option>
        <option value="ja-JP">æ—¥æœ¬èª</option>
        <option value="fr-FR">FranÃ§ais</option>
    </select>
    <button class="control" id="btnB" onclick="startRecognition('B')">User B é–‹å§‹èªªè©±</button>
    <div class="row">
        <figure class="msg-box">
            <figcaption>èªéŸ³è¾¨è­˜</figcaption>
            <div id="resultB"></div>
        </figure>
        <figure class="msg-box">
            <figcaption>ç¿»è­¯çµæœ</figcaption>
            <div id="translatedA"></div>
        </figure>
    </div>
</div>

<!-- OpenCCï¼ˆOpen Chinese Convertï¼‰é–‹æºçš„ä¸­æ–‡ç¹ç°¡è½‰æ›å·¥å…· -->
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>


<script>

    let langA;
    let langB;

    let current_user;


    let counter = 0;

    // èªéŸ³éŸ³é‡æ¢é¡¯ç¤º
    let audioContext, analyser, micSource;
    let volumeTimer;

    let recognition;
    let stream; // å­˜æ”¾ MediaStream
    let timeoutTimer; // è¨˜éŒ„è¶…æ™‚è¨ˆæ™‚å™¨
    const MAX_DURATION = 10000; // 10ç§’è¶…æ™‚

    //let converter;

    //const OpenCC = require('opencc-js');
    //const converter = OpenCC.Converter('s2twp');

    // åˆå§‹åŒ–è½‰æ›å™¨ opencc
    const converter = OpenCC.Converter({ from: 'cn', to: 'tw' });

    // ä½¿ç”¨ï¼šç°¡é«”è½‰ç¹é«” opencc
    function convertSimplifiedToTraditional(text) {
        if (!converter) return text; // è‹¥å°šæœªå°±ç·’ï¼Œç›´æ¥å›å‚³åŸæ–‡
        return converter(text);
    }

    // ç´€éŒ„ç‹€æ…‹è¨Šæ¯
    function showStatus(message) {
        //document.getElementById("status").innerText = message;
        const statusEl = document.getElementById("status");
        const newMsg = `<div>${message}</div>`;
        statusEl.innerHTML = newMsg + statusEl.innerHTML;
    }

    function appInit() {

        showStatus("ğŸš€ æ‡‰ç”¨ç¨‹å¼å·²å•Ÿå‹•.");

        // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´æ€§
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition;
        if (!SpeechRecognition) {
        showStatus("âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ API");
        return;
        }

        //checkMicrophonePermission();

        test();
    }


    // 250606 001 WebViewè¼‰å…¥htmlé é¢åˆå§‹å®Œæˆæ™‚, å°±æœƒè‡ªå‹•åŸ·è¡Œæ­¤å‡½å¼, æ¥æ”¶è¨Šæ¯
    function fromWebView(message) {
        showStatus(message);
    }

    // åœæ­¢ä¸¦é‡‹æ”¾éº¥å…‹é¢¨è³‡æº
    function stopStream() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            showStatus("ğŸ¤ éº¥å…‹é¢¨å·²é‡‹æ”¾");
        }
    }

    //let testMedia;

    async function test(){

    const info = `
    appCodeName: ${navigator.appCodeName}
    \nappName: ${navigator.appName}
    \nappVersion: ${navigator.appVersion}
    \nuserAgent: ${navigator.userAgent}
    \nplatform: ${navigator.platform}
  `;

  //document.getElementById("info").innerText = info;
    showStatus("Info:" + info);
    }

    function checkMicrophonePermission() {

      counter++;
      console.log(`ğŸ”¢ checkMicrophonePermission ç¬¬ ${counter} æ¬¡åŸ·è¡Œ`);
      console.trace("ğŸ“ å‘¼å«ä¾†æº");

      navigator.permissions.query({ name: "microphone" }).then(result => {
    console.log("ğŸ¤ Microphone permission status:", result.state);
});



      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("âŒ ç€è¦½å™¨ä¸æ”¯æ´ getUserMediaï¼");
      return;
      }


        try {
          console.log("âœ… å‘¼å« getUserMedia ä¸­...");

          navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
               console.log("âœ… æˆåŠŸå–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼");
               showStatus("ğŸ¤ éº¥å…‹é¢¨æ¬Šé™å·²æˆæ¬Šï¼");
               stream.getTracks().forEach(track => track.stop());
            })
            .catch(function(err) {
               console.log("âŒ ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼š", err);
               showStatus("âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ï¼" + err);
               //alert('éŒ¯èª¤: ' + err);
            });
        } catch (e) {
          console.error("ğŸš« å‘¼å« getUserMedia æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", e);
          alert("ğŸš« å‘¼å« getUserMedia æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + e);
          }

            /*
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    showStatus("ğŸ¤ éº¥å…‹é¢¨æ¬Šé™å·²æˆæ¬Šï¼");
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(function(err) {
                    showStatus("âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ï¼");
                    //alert("éœ€è¦éº¥å…‹é¢¨æ¬Šé™æ‰èƒ½ä½¿ç”¨èªéŸ³è¾¨è­˜åŠŸèƒ½ï¼");
                    alert('éŒ¯èª¤:', err);
                });

            */
    }

    function startRecognition(user) {

        if (!('webkitSpeechRecognition' in window)) {
            //alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API");
            showStatus("âš ï¸ç›®å‰ä½¿ç”¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼");
            return;
        }

        // æ¯æ¬¡æŒ‰ä¸‹æŒ‰éˆ• å…ˆæŠŠä¹‹å‰å ç”¨çš„è³‡æºé‡‹æ”¾å‡ºä¾†

        if (recognition) {
            try {
                recognition.abort();
                showStatus("âœ… é‡‹æ”¾èªéŸ³è¾¨è­˜è³‡æºã€‚");
            } catch(e) {
                //console.warn("abort() å¤±æ•—", e);
                showStatus("ğŸš« ç„¡æ³•é‡‹æ”¾èªéŸ³è¾¨è­˜è³‡æº:" + e);
            }
            recognition = null;
            showStatus("âœ… recognition ç‚º nullã€‚");
        }

        //stopStream();

        //checkMicrophonePermission();

        current_user = user;

        langA = document.getElementById('langA').value;
        langB = document.getElementById('langB').value;

        const btn = document.getElementById(user === 'A' ? 'btnA' : 'btnB');
        const result = document.getElementById(user === 'A' ? 'resultA' : 'resultB');

        const userLang = user === 'A' ? langA : langB;
        const targetLang = user === 'A' ? langB : langA;

        recognition = new webkitSpeechRecognition();
        recognition.lang = userLang;
        recognition.interimResults = false; //ä¸è¦ç”šéº¼è²éŸ³éƒ½æ”¶é€²ä¾†
        //recognition.interimResults = true;  //ç”šéº¼è²éŸ³éƒ½æ”¶é€²ä¾†
        recognition.maxAlternatives = 1;

        //btn.disabled = true;
        ChangeElementsStatus(false);
        btn.innerText = "ğŸ™ï¸ è¾¨è­˜ä¸­...";
        startBlink(btn);

        // å•Ÿå‹•è¶…æ™‚è¨ˆæ™‚å™¨
        clearTimeout(timeoutTimer);
        showStatus(`â³ è¨ˆæ™‚å™¨å•Ÿå‹•ã€‚`)

        timeoutTimer = setTimeout(() => {
            //console.warn("è¾¨è­˜è¶…æ™‚ï¼Œè‡ªå‹•åœæ­¢ã€‚");
            //showStatus(`è¾¨è­˜è¶…æ™‚ï¼Œè‡ªå‹•åœæ­¢ã€‚`)
            recognition.abort();
            //alert("è¾¨è­˜è¶…æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼");
            showStatus(`ğŸš« è¾¨è­˜è¶…æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼`);
            //resetButton(btn, user);
        }, MAX_DURATION);

        showStatus(`ğŸ™ï¸ User ${user} é–‹å§‹èªéŸ³è¾¨è­˜ (${userLang})...`);

        recognition.onspeechstart = function(event) {
          showStatus(`âœ… User ${user} ç›®å‰è¾¨è­˜å‡ºèªéŸ³:` + event);
        };

        recognition.onstart = function(event) {
          showStatus(`âœ… User ${user} èªéŸ³è¾¨è­˜æµç¨‹é–‹å§‹:` + event);
        };

        recognition.onaudioend = function(event) {
          showStatus(`âœ… User ${user} çµæŸç’°å¢ƒæ”¶éŸ³:` + event);
        };

        recognition.onaudiostart = function(event) {
          showStatus(`âœ… User ${user} é–‹å§‹ç’°å¢ƒæ”¶éŸ³:` + event);
        };

        recognition.onsoundstart = function(event) {
          showStatus(`âœ… User ${user} ç›®å‰åµæ¸¬åˆ°æœ‰è²éŸ³è¼¸å…¥:` + event);
        };

        recognition.onsoundend = function(event) {
          showStatus(`âœ… User ${user} åµæ¸¬åˆ°çš„è²éŸ³åœæ­¢äº†:` + event);
        };

        recognition.onspeechend = function(event) {
          showStatus(`âœ… User ${user} ç›®å‰ç„¡å¯è¾¨è­˜èªéŸ³:` + event);
        };

        recognition.onnomatch = function(event) {
          showStatus(`âœ… User ${user} æ²’æœ‰ç›¸æ‡‰çš„èªéŸ³` + event);
        };

        recognition.onresult = function(event) {
            clearTimeout(timeoutTimer); // æˆåŠŸå¾Œæ¸…é™¤è¶…æ™‚
            const transcript = event.results[0][0].transcript;

            if (recognition.lang == "zh-TW") {
               result.innerHTML = `<div>${convertSimplifiedToTraditional(transcript)}</div>` + result.innerHTML;
            } else {
               result.innerHTML = `<div>${transcript}</div>` + result.innerHTML;
            }

            showStatus(`âœ… User ${user} èªéŸ³è¾¨è­˜å®Œæˆï¼Œæº–å‚™ç¿»è­¯...`);

            if (window.Android && window.Android.translate) {
                const fromLang = userLang.substring(0, 2);
                const toLang = targetLang.substring(0, 2);
                window.Android.translate(transcript, fromLang, toLang);
            }
        };

        recognition.onerror = function(event) {
            clearTimeout(timeoutTimer); // è¾¨è­˜éŒ¯èª¤å¾Œæ¸…é™¤è¶…æ™‚
            //alert("è¾¨è­˜éŒ¯èª¤: " + event.error);
            //btn.disabled = false;
            ChangeElementsStatus(true);
            btn.innerText = user === 'A' ? "User A é–‹å§‹èªªè©±" : "User B é–‹å§‹èªªè©±";
            stopBlink(btn);
            showStatus(`âŒ User ${user} è¾¨è­˜éŒ¯èª¤: ${event.error}`);
        };

        recognition.onend = function() {
            clearTimeout(timeoutTimer); // çµæŸå¾Œæ¸…é™¤è¶…æ™‚
            //btn.disabled = false;
            ChangeElementsStatus(true);
            btn.innerText = user === 'A' ? "User A é–‹å§‹èªªè©±" : "User B é–‹å§‹èªªè©±";
            stopBlink(btn);
            showStatus(`ğŸ›‘ User ${user} è¾¨è­˜çµæŸã€‚`);
        }

        try {
              recognition.start();
              //console.log("ğŸ™ï¸ SpeechRecognition å·²å•Ÿå‹•ï¼");
              showStatus(`ğŸ™ï¸ User ${user} SpeechRecognition å·²å•Ÿå‹•ã€‚`);
            } catch (e) {
              //console.error("ğŸš« SpeechRecognition.start() ä¾‹å¤–ç™¼ç”Ÿ:", e);
              //alert("ğŸš« å•Ÿå‹•èªéŸ³è¾¨è­˜æ™‚ç™¼ç”Ÿä¾‹å¤–ï¼š" + e.message);
              showStatus(`ğŸš« User ${user} å•Ÿå‹•èªéŸ³è¾¨è­˜æ™‚ç™¼ç”Ÿä¾‹å¤–ï¼š` + e.message);
            }

    }

    function showTranslatedText(originalText, translatedText, targetLang) {

        /*
        const target = targetLang.toLowerCase();

        if (target === document.getElementById('langA').value.substring(0,2)) {
            translatedB.innerHTML = `<div>${translatedText}</div>` + translatedB.innerHTML;
            showStatus(`ğŸŒ ç¿»è­¯å®Œæˆ (User B â” User A): ${translatedText}`);
        } else if (target === document.getElementById('langB').value.substring(0,2)) {
            translatedA.innerHTML = `<div>${translatedText}</div>` + translatedA.innerHTML;
            showStatus(`ğŸŒ ç¿»è­¯å®Œæˆ (User A â” User B): ${translatedText}`);
        }
        */

        if (targetLang == "zh") {
               translatedText = convertSimplifiedToTraditional(translatedText);
            }

        if (current_user === 'B') {
            translatedB.innerHTML = `<div>${translatedText}</div>` + translatedB.innerHTML;
            showStatus(`ğŸŒ ç¿»è­¯å®Œæˆ (User B â” User A): ${translatedText}`);
        } else if (current_user === 'A') {
            translatedA.innerHTML = `<div>${translatedText}</div>` + translatedA.innerHTML;
            showStatus(`ğŸŒ ç¿»è­¯å®Œæˆ (User A â” User B): ${translatedText}`);
        }
        ChangeElementsStatus(true);
    }

    // é–‹å§‹é–ƒçˆ
    function startBlink(button) {
        button.classList.add("flash-button");
    }

    // åœæ­¢é–ƒçˆ
    function stopBlink(button) {
        button.classList.remove("flash-button");
    }

    // æ”¹è®Šå…ƒä»¶ç‹€æ…‹ (å•Ÿç”¨/ åœç”¨)
    function ChangeElementsStatus(status)
    {
        const elements = document.querySelectorAll(".control");
        elements.forEach(el => {
        el.disabled = !status;
        });
    }

 /* // 250607 ä¸ç”¨äº†
    (function () {
  const originalGetUserMedia = navigator.mediaDevices.getUserMedia;

  navigator.mediaDevices.getUserMedia = function (constraints) {
    //console.log("ğŸ™ï¸ å‘¼å« getUserMedia()ï¼Œåƒæ•¸ï¼š", constraints);

    return originalGetUserMedia.call(this, constraints)
      .then(stream => {
        //console.log("âœ… æˆåŠŸå–å¾— MediaStreamï¼š", stream);

        // é¡å¤–ï¼šåˆ—å‡ºæ‰€æœ‰ tracks
        stream.getTracks().forEach((track, index) => {
          //console.log(`ğŸ”Š Track ${index + 1}: kind=${track.kind}, label=${track.label}`);
        });

        return stream;
      })
      .catch(error => {
        //console.error("âŒ å–å¾—éº¥å…‹é¢¨å¤±æ•—ï¼š", error.name, "-", error.message);
        throw error; // ç¹¼çºŒå¾€ä¸Šä¸ŸéŒ¯èª¤
      });
  };
})();
    */
</script>

</body>
</html>
